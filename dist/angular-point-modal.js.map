{"version":3,"sources":["angular-point-modal-service.ts","index.ts"],"names":["ap","ap.modal","ap.modal.APModal","ap.modal.APModal.constructor","ap.modal.APModal.cancel","ap.modal.APModal.deleteListItem","ap.modal.APModal.saveListItem","ap.modal.APModal.generateError","ap.modal.APModalService","ap.modal.APModalService.constructor","ap.modal.APModalService.modalModelProvider","ap.modal.APModalService.modalModelProvider.openModal","ap.modal.unlockOnClose"],"mappings":"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","file":"angular-point-modal.js","sourcesContent":["/// <reference path=\"../typings/tsd.d.ts\" />\n\nmodule ap.modal {\n    'use strict';\n\n\n    var toastr: Toastr, $uibModal: angular.ui.bootstrap.IModalService, $q: ng.IQService;\n\n    export interface IPermObject {\n        resolvePermissions(): {\n            EditListItems: boolean;\n            DeleteListItems: boolean;\n            ApproveItems: boolean;\n            FullMask: boolean;\n        };\n    }\n\n    export class APModal {\n        $uibModalInstance: ng.ui.bootstrap.IModalServiceInstance;\n        displayMode: string;\n        fullControl = false;\n        listItem: ListItem<any>\n        negotiatingWithServer = false;\n        userCanApprove = false;\n        userCanDelete = false;\n        userCanEdit = false;\n\n        constructor(listItem: ListItem<any>, $uibModalInstance: ng.ui.bootstrap.IModalServiceInstance) {\n            \n            //Manually declare to make it more obvious what's available to all child classes\n            this.listItem = listItem;\n            this.$uibModalInstance = $uibModalInstance;\n\n            var resolvePermissions = (permObj: IPermObject) => {\n                var userPermMask = permObj.resolvePermissions();\n                this.userCanEdit = userPermMask.EditListItems;\n                this.userCanDelete = userPermMask.DeleteListItems;\n                this.userCanApprove = userPermMask.ApproveItems;\n                this.fullControl = userPermMask.FullMask;\n            };\n\n            if (listItem && listItem.id && listItem.resolvePermissions) {\n                resolvePermissions(listItem);\n            } else if (listItem.getModel && listItem.getModel().resolvePermissions) {\n                /** Fallback to retrieve permissions from the model when a list item isn't available */\n                resolvePermissions(listItem.getModel());\n            }\n\n            /** Check if it's a new form */\n            if (!listItem || !listItem.id) {\n                this.displayMode = 'New';\n            } else if (this.userCanEdit) {\n                this.displayMode = 'Edit';\n            } else {\n                this.displayMode = 'View';\n            }\n        }\n\n        cancel(): void {\n            this.$uibModalInstance.dismiss('cancel');\n        }\n\n        /**\n         * @ngdoc function\n         * @name angularPoint.apModalService:deleteListItem\n         * @methodOf angularPoint.apModalService\n         * @description\n         * Prompts for confirmation of deletion, then deletes and closes modal\n         * @param {object} [options] Options to pass to ListItem.deleteItem().\n         * @example\n         *\n         * <pre>\n         * <button type=\"button\" class=\"btn btn-danger\" ng-click=\"vm.deleteListItem()\"\n         *          ng-show=\"vm.projectDocument.id && vm.userCanDelete\"\n         *          title=\"Delete this document.\">\n         *      <i class=\"fa fa-trash-o\"></i>\n         *  </button>\n         * </pre>\n         */\n        deleteListItem(options?): ng.IPromise<any> {\n            var confirmation = window.confirm('Are you sure you want to delete this record?');\n            if (confirmation) {\n                /** Disable form buttons */\n                this.negotiatingWithServer = true;\n\n                return this.listItem.deleteItem(options)\n                    .then(() => {\n                        toastr.success('Record deleted successfully');\n                        return this.$uibModalInstance.close();\n                    }).catch((err) => {\n                        throw this.generateError('deleting', err);\n                    });\n            }\n        }\n\n        /**\n         * @ngdoc function\n         * @name angularPoint.apModalService:saveListItem\n         * @methodOf angularPoint.apModalService\n         * @description\n         * Creates a new record if necessary, updates list item if it already exists, and closes\n         * if no significant changes have been made. \n         * @param {object} [options] Options to pass to ListItem.saveChanges().\n         * @example\n         * <pre>\n         *  <button class=\"btn btn-primary\" type=\"submit\"\n         *      ng-disabled=\"vm.form.$invalid || !vm.userCanEdit\">Save</button>\n         * </pre>\n         */\n        saveListItem(options?): ng.IPromise<any> {\n            let promise;\n\n            if (this.listItem.id && this.listItem.isPristine()) {\n                promise = $q.when(this.listItem);\n                //No significant changes have been made so just close\n                this.cancel();\n            } else {\n                promise = this.listItem.saveChanges(options);\n\n                promise\n                    .then(() => {\n                        toastr.success('Record updated');\n                        this.$uibModalInstance.close();\n                    })\n                    .catch((err) => {\n                        throw this.generateError('updating', err);\n                    });\n            }\n\n            return promise;\n        }\n        private generateError(action: string, err): Error {\n            toastr.error(`There was a problem ${action} this record.  We've logged the issue and are looking into it.  Any additional information you can provide would be appreciated.`);\n            return new Error(`Summary: Error ${action} list item from modal.\n                Error: ${err}\n                ListItem: ${JSON.stringify(this.listItem, null, 2) }`);\n        }\n    }\n\n    export class APModalService {\n        static $inject = ['toastr', '$uibModal', '$q'];\n\n        constructor(_toastr_, _$uibModal_, _$q_) {\n            toastr = _toastr_;\n            $uibModal = _$uibModal_;\n            $q = _$q_;\n        }\n\n        /**\n         * @ngdoc function\n         * @name angularPoint.apModalService:modalModelProvider\n         * @methodOf angularPoint.apModalService\n         * @description\n         * Extends a model to allow us to easily attach a modal form that accepts and injects a\n         * dynamic number of arguments.\n         * @param {object} config Configuration object.\n         * @param {string} config.templateUrl Reference to the modal view.\n         * @param {string} config.controller Name of the modal controller.\n         * @param {function} [config.resolver] Pass arguments received to this function which creates the necessary resolve object.\n         * @param {boolean} [config.lock] Use sync service to register a lock event.\n         * @returns {function(any=): angular.IPromise<any>} Function which returns openModal that in turn returns a promise.\n         *\n         * @example\n         * <pre>\n         *    model.openModal = apModalService.modalModelProvider({\n         *        templateUrl: 'modules/comp_request/views/comp_request_modal_view.html',\n         *        controller: 'compRequestModalCtrl',\n         *        controllerAs: 'vm',\n         *        resolver: function(project) {\n         *            return {\n         *                project: () => project\n         *            }\n         *        }\n         *    });\n         * </pre>\n         */\n        modalModelProvider(config: { templateUrl: string; controller: string; resolver?: Function; size?: string; controllerAs?: string; lock?: boolean; }): (listItem?) => angular.IPromise<any> {\n            return function openModal(listItem?: ap.ListItem<any>) {\n                var model = this, lockInfo;\n                listItem = listItem || model.createEmptyItem();\n\n                var defaults = {\n                    templateUrl: config.templateUrl,\n                    controller: config.controller,\n                    resolve: {}\n                };\n\n                /** Pass through any arguments to the resolver function to allow for dynamic resolve object\n                 * to be created with the only assumption being the list item being edited is the first param */\n                if (_.isFunction(config.resolver)) {\n                    defaults.resolve = config.resolver.apply(config.resolver, arguments);\n                }\n\n                /** Optionally lock the list item for editing if the the sync service is included */\n                if (config.lock) {\n                    lockInfo = listItem.lock();\n                    defaults.resolve.lockInfo = () => lockInfo;\n                }\n\n                var modalConfig = _.assign({}, defaults, config);\n                var modalInstance = $uibModal.open(modalConfig);\n\n                if (listItem.id) {\n\n                    modalInstance.result\n                        .then(function() {\n                            unlockOnClose(config.lock, lockInfo);\n                        })\n                        .catch(function() {\n                            /** Revert back any changes that were made to editable fields, leaving changes made\n                             * to readonly fields like attachments */\n                            listItem.setPristine(listItem);\n                            unlockOnClose(config.lock, lockInfo);\n                        });\n                }\n\n                return modalInstance.result;\n            };\n        }\n\n\n    }\n\n    function unlockOnClose(lock, lockInfo) {\n        if (lock) {\n            //Users without sufficient permissions won't be able to lock so only unlock in the event \n            lockInfo.then((resolvedInfo) => _.isFunction(resolvedInfo.unlock) ? resolvedInfo.unlock() : undefined);\n        }\n    }\n\n}\n","/// <reference path=\"../typings/tsd.d.ts\" />\n/// <reference path=\"../typings/ap.d.ts\" />\n\nmodule ap.modal {\n    'use strict';\n\t\n    /**\n     * @ngdoc service\n     * @name ap.apModalService\n     * @description\n     * Extends a modal form to include many standard functions\n     *\n     */\n    angular.module('apModal', ['angularPoint', 'ui.bootstrap', 'toastr'])\n        .service('apModalService', APModalService);\n}"],"sourceRoot":"/source/"}